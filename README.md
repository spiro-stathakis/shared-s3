# Shared S3 Access Scripts (NooBaa)

Scripts for accessing NooBaa S3 storage via Rook OBC (ObjectBucketClaim) with proper read-only user support.

## Quick Start

```bash
# Read from S3 (sync from bucket to local)
./s3_wrapper.sh read s3://folder/ ./local-folder/

# Write to S3 (sync from local to bucket)
./s3_wrapper.sh write ./local-folder/ s3://folder/

# List bucket contents
./s3_list.sh

# Delete objects
./s3_delete.sh s3://folder/file.txt
```

## Why NooBaa?

NooBaa (Multicloud Object Gateway) provides proper support for read-only users through:

- **Unified Authentication**: All NooBaa accounts exist in the same authentication realm
- **Working Bucket Policies**: S3 bucket policies can grant permissions between NooBaa accounts
- **Read-Only Accounts**: Create dedicated accounts with `--allow_bucket_create=false`
- **S3 API Compatibility**: Full compatibility with AWS S3 API and tools

This solves the authentication realm issue that exists with Ceph RGW OBC buckets.

## Setup Instructions

### 1. Create Namespace and OBC

```bash
# Create namespace
oc apply -f init/namespace.yaml

# Create ObjectBucketClaim using NooBaa storage class
oc apply -f init/obc.yaml
```

Wait for the OBC to be provisioned:
```bash
oc get obc -n shared-data
```

### 2. Create Read-Only NooBaa Account

```bash
cd init
./10_create_readonly_account.sh
```

This creates a NooBaa account named `readonly-user` with `allow_bucket_create=false`.

### 3. Apply Bucket Policy

```bash
cd init
./20_apply_policy.sh
```

This applies an S3 bucket policy that grants the readonly-user read-only access to the bucket.

### 4. Verify Setup

```bash
cd init
./30_verify_setup.sh
```

This verifies:
- NooBaa readonly account exists
- Bucket policy is applied
- Read-only user can list and sync from the bucket

## Scripts

### s3_wrapper.sh

Main script for syncing files between S3 and local filesystem.

**Usage:**
```bash
./s3_wrapper.sh [command] [--dryrun] [source] [destination]
```

**Commands:**
- `read` - Sync FROM S3 TO local (download) - uses READ-ONLY credentials
- `write` - Sync FROM local TO S3 (upload) - uses WRITE credentials

**Flags:**
- `--dryrun` - Preview changes without making them

**Path Format:**
- S3 paths: `s3://folder/` (bucket name is auto-detected and prepended)
- Local paths: `./folder/` or absolute paths

**Examples:**
```bash
# Download entire bucket
./s3_wrapper.sh read s3:// ./backup/

# Download specific folder
./s3_wrapper.sh read s3://shared-s3/ ./local-data/

# Upload folder
./s3_wrapper.sh write ./data/ s3://backup/

# Dry run upload
./s3_wrapper.sh write --dryrun ./data/ s3://backup/
```

### s3_list.sh

List bucket contents recursively.

**Usage:**
```bash
./s3_list.sh
```

Uses READ-ONLY credentials by default.

### s3_delete.sh

Delete objects from S3.

**Usage:**
```bash
./s3_delete.sh s3://path/to/file.txt
./s3_delete.sh s3://folder/  # Delete entire folder recursively
```

Uses WRITE credentials (required for delete operations).

## Technical Details

### Credential Sources

**READ credentials** (readonly-user):
- Created via: `noobaa account create readonly-user --allow_bucket_create=false`
- Source: NooBaa secret in openshift-storage namespace
- Format: `readonly-user` account in NooBaa
- Permissions: Read-only access via bucket policy

**WRITE credentials** (OBC user):
- Created via: ObjectBucketClaim in `shared-data` namespace
- Source: Kubernetes secrets (`shared-data-bucket`)
- User ID format: Generated by NooBaa OBC provisioner
- Permissions: Full access to the bucket

### NooBaa Account Format

NooBaa accounts use the format: `account-name@noobaa.io`

In bucket policies, the Principal ARN format is:
```json
"Principal": {
  "AWS": ["arn:aws:iam::noobaa:user/readonly-user@noobaa.io"]
}
```

### S3 Endpoint

NooBaa exposes S3 API through the `s3` route in `openshift-storage` namespace:
```bash
https://s3-openshift-storage.apps.your-cluster.domain
```

### Directory Structure

```
.
├── README.md               # This file
├── s3_wrapper.sh           # Main sync script
├── s3_list.sh              # List objects
├── s3_delete.sh            # Delete objects
├── set_read_env.sh         # Load READ credentials
├── set_write_env.sh        # Load WRITE credentials
├── init/                   # Setup scripts
│   ├── namespace.yaml
│   ├── obc.yaml
│   ├── policy.json
│   ├── 10_create_readonly_account.sh
│   ├── 20_apply_policy.sh
│   └── 30_verify_setup.sh
```

## Troubleshooting

### "Could not find NooBaa pod"

**Cause:** NooBaa operator is not running or not installed.

**Solution:** Check NooBaa installation:
```bash
oc get pods -n openshift-storage -l noobaa-mgmt=noobaa
```

### "NooBaa account does not exist"

**Cause:** The readonly-user account hasn't been created.

**Solution:** Run the account creation script:
```bash
cd init && ./10_create_readonly_account.sh
```

### "No bucket policy found"

**Cause:** Bucket policy hasn't been applied.

**Solution:** Apply the bucket policy:
```bash
cd init && ./20_apply_policy.sh
```

### "AccessDenied" with readonly-user

**Cause:** Bucket policy may not be properly configured or applied.

**Solution:**
1. Verify policy is applied: `cd init && ./30_verify_setup.sh`
2. Re-apply policy: `cd init && ./20_apply_policy.sh`
3. Check the account exists: `oc get secret readonly-user -n openshift-storage`

### S3 endpoint not found

**Cause:** NooBaa S3 route doesn't exist.

**Solution:** Check the route exists:
```bash
oc get route s3 -n openshift-storage
```

If missing, check NooBaa installation.

## Environment Variables

Scripts automatically load these from OpenShift:

- `S3_ENDPOINT_URL` - NooBaa S3 endpoint URL (from `s3` route)
- `BUCKET_NAME` - OBC bucket name (from ConfigMap)
- `READ_ACCESS_KEY` / `READ_SECRET_KEY` - readonly-user credentials (from NooBaa secret)
- `WRITE_ACCESS_KEY` / `WRITE_SECRET_KEY` - OBC user credentials (from OBC secret)

## Requirements

- OpenShift CLI (`oc`) configured and logged in
- Podman
- `jq` for JSON parsing
- Access to `openshift-storage` namespace (for NooBaa operations)
- Access to `shared-data` namespace (for OBC credentials)
- NooBaa operator installed (part of OpenShift Data Foundation)

## Advantages Over Ceph RGW

| Feature | NooBaa | Ceph RGW OBC |
|---------|--------|--------------|
| Read-only users | ✅ Supported | ❌ Not supported |
| Bucket policies | ✅ Work correctly | ❌ Cross-realm issues |
| User management | Unified in NooBaa | Split (OBC vs radosgw-admin) |
| S3 compatibility | Full | Full |
| Multi-cloud | ✅ Built-in | Limited |

## References

- [NooBaa Documentation](https://www.noobaa.io/)
- [Rook OBC Documentation](https://rook.io/docs/rook/latest/Storage-Configuration/Object-Storage-RGW/object-bucket-claim/)
- [Red Hat OpenShift Data Foundation - Bucket Policies](https://docs.redhat.com/en/documentation/red_hat_openshift_data_foundation/4.15/html/managing_hybrid_and_multicloud_resources/bucket-policies-in-the-multicloud-object-gateway)
- [S3 Bucket Policy Examples for NooBaa](https://medium.com/@sandeepm257/s3-bucket-policy-in-noobaa-mcg-on-openshift-how-to-restrict-bucket-access-8323f6093e1d)
